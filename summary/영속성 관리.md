<h2>영속성 관리</h2><br>
<h2>JPA에서 가장 중요한 2가지</h2>
<ul>
  <li>객체와 관계형 데이터베이스 매핑하기(Object Relational Mapping)</li>
  <li>영속성 컨텍스트</li>
</ul>
<h2>엔티티 매니저 팩토리와 엔티티 매니저</h2>
<img src="https://user-images.githubusercontent.com/76415175/110706180-cc2ac080-823a-11eb-95b9-2b8193053f02.PNG">
<h2>영속성 컨텍스트</h2>
<ul>
  <li>JPA를 이해하는데 가장 중요한 용어</li>
  <li>엔티티를 영구 저장하는 환경 이라는 뜻</li>
  <li>EntityManager.persist(entity);</li>
</ul>
<h2>엔티티 매니저? 영속성 컨텍스트?</h2>
<ul>
  <li>영속성 컨텍스트는 논리적 개념</li>
  <li>눈에 보이지 않는다</li>
  <li>엔티티 매니저를 통해서 영속성 컨텍스트에 접근</li>
</ul>
<img src="https://user-images.githubusercontent.com/76415175/110706412-23c92c00-823b-11eb-8979-45d1da411346.PNG">
<h2>엔티티의 생명주기</h2>
<ul>
  <li>비영속 (new/transient) : 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태</li>
  <li>영속 (managed) : 영속성 컨텍스트에 관리되는 상태</li>
  <li>준영속 (detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태</li>
  <li>삭제 (removed) : 삭제된 상태</li>
</ul>
<img src="https://user-images.githubusercontent.com/76415175/110706567-6ab72180-823b-11eb-8a13-cbd11bf8f4ff.PNG">
<h2>비영속</h2>
<img src="https://user-images.githubusercontent.com/76415175/110706670-9508df00-823b-11eb-9d61-6441cf9c38a2.PNG">
<pre>
//객체를 생성한 상태(비영속) 
Member member = new Member(); 
member.setId("member1"); 
member.setUsername("회원1");
</pre>
<h2>영속</h2>
<img src="https://user-images.githubusercontent.com/76415175/110706771-b7026180-823b-11eb-9e2f-22f59f5280ff.PNG">
<pre>
//객체를 생성한 상태(비영속) 
Member member = new Member(); 
member.setId("member1"); 
member.setUsername(“회원1”);
EntityManager em = emf.createEntityManager();
em.getTransaction().begin();
//객체를 저장한 상태(영속)
em.persist(member);
</pre>
<h2>준영속/삭제</h2>
<pre>
//회원 엔티티를 영속성 컨텍스트에서 분리, 준영속 상태 
em.detach(member);
//객체를 삭제한 상태(삭제) 
em.remove(member);
</pre>
<h2>영속성 컨텍스트의 이점</h2>
<ul>
  <li>1차 캐시</li>
  <li>동일성(identity) 보장</li>
  <li>트랜잭션을 지원하는 쓰기 지연(transactional write-behind)</li>
  <li>변경 감지(Dirty Checking)</li>
  <li>지연 로딩(Lazy Loading)</li>
</ul>
<h2>플러시</h2>
<span>영속성 컨텍스트의 변경내용을 데이터베이스에 반영</span>
<h3>플러시 발생</h3>
<ul>
  <li>변경 감지</li>
  <li>수정된 엔티티 쓰기 지연 SQL 저장소에 등록</li>
  <li>쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송 (등록, 수정, 삭제 쿼리)</li>
</ul>
<h3>영속성 컨텍스트를 플러시하는 방법</h3>
<ul>
  <li>em.flush() - 직접 호출</li>
  <li>트랜잭션 커밋 - 플러시 자동 호출</li>
  <li>JPQL 쿼리 실행 - 플러시 자동 호출</li>
</ul>
<h3>플러시는?</h3>
<ul>
  <li>영속성 컨텍스트를 비우지 않음</li>
  <li>영속성 컨텍스트의 변경내용을 데이터베이스에 동기화</li>
  <li>트랜잭션이라는 작업 단위가 중요 -> 커밋 직전에만 동기화 하면 됨</li>
</ul>
<h2>준영속 상태</h2>
<ul>
  <li>영속 -> 준영속</li>
  <li>영속 상태의 엔티티가 영속성 컨텍스트에서 분리(detached)</li>
  <li>영속성 컨텍스트가 제공하는 기능을 사용 못함</li>
</ul>
<h2>준영속 상태로 만드는 방법</h2>
<ul>
  <li>em.detach(entity) : 특정 엔티티만 준영속 상태로 전환</li>
  <li>em.clear() : 영속성 컨텍스트를 완전히 초기화</li>
  <li>em.close() : 영속성 컨텍스트를 종료</li>
</ul>
